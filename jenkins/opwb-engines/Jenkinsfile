// jenkinsfile
pipeline {
    agent {
        docker {
            image 'maven:3.9.11-eclipse-temurin-21'
            args '-u root:root -v maven-m2-cache:/root/.m2/repository'
        }
    }

    stages {
        // ====================================================================
        // 新增阶段：在构建开始时手动清理工作空间
        // ====================================================================
        stage('Clean Workspace') {
            steps {
                echo 'INFO: Manually cleaning workspace...'
                // 在容器内以 root 权限执行清理，为本次构建准备干净的环境。
                sh '''
                    set -x
                    (cd lts-dependency && git clean -fdx) || true
                    (cd main-project && git clean -fdx) || true
                '''
            }
        }

        // ====================================================================
        // 阶段一：在子目录中构建 lts 依赖
        // ====================================================================
        stage('Build Dependency: lts') {
            steps {
                dir('lts-dependency') {
                    echo '进入 lts-dependency 目录，准备检出 light-task-scheduler...'
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/master']],
                        userRemoteConfigs: [[
                            url: 'https://gitee.com/changyunhuizhi/light-task-scheduler.git',
                            credentialsId: 'd5208b73-a80f-403b-a5df-365614d1362e'
                        ]]
                    ])

                    configFileProvider([configFile(fileId: 'maven-aliyun-settings', variable: 'MAVEN_SETTINGS')]) {
                        script {
                            echo "INFO: 成功加载 Jenkins 全局 Maven 配置文件 (ID: maven-aliyun-settings)..."
                            sh "git config --global --add safe.directory ${env.WORKSPACE}/lts-dependency"

                            def currentHash = sh(script: "git rev-parse HEAD", returnStdout: true).trim()
                            def hashFile = "${env.JENKINS_HOME}/lts-commit-hash.txt"
                            def lastHash = fileExists(hashFile) ? readFile(hashFile).trim() : ""

                            if (currentHash != lastHash) {
                                echo "检测到 lts 有新提交，执行 mvn install..."
                                sh "mvn -s ${MAVEN_SETTINGS} -T 8 clean install -DskipTests"
                                writeFile file: hashFile, text: currentHash
                            } else {
                                echo "lts 代码无变化，跳过构建。"
                            }
                        }
                    }
                }
            }
        }

        // ====================================================================
        // 阶段二：在子目录中构建主项目
        // ====================================================================
        stage('Build Main Project') {
            steps {
                dir('main-project') {
                    echo '进入 main-project 目录，准备检出 opwb-engines 主项目...'
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/workbench-2023']],
                        userRemoteConfigs: [[
                            url: 'https://gitee.com/changyunhuizhi/opwb-engines.git',
                            credentialsId: 'd5208b73-a80f-403b-a5df-365614d1362e'
                        ]]
                    ])

                    configFileProvider([configFile(fileId: 'maven-aliyun-settings', variable: 'MAVEN_SETTINGS')]) {
                        script {
                            echo "INFO: 成功加载 Jenkins 全局 Maven 配置文件 (ID: maven-aliyun-settings)..."
                            sh "git config --global --add safe.directory ${env.WORKSPACE}/main-project"

                            echo '正在执行 Maven 构建...'
                            sh "mvn -s ${MAVEN_SETTINGS} -T 8 clean package -DskipTests -U"
                        }
                    }
                }
            }
        }

        // ====================================================================
        // 阶段三：归档到共享目录
        // ====================================================================
        stage('Archive to Share') {
            steps {
                script {
                    def timestamp = new Date().format('yy-MM-dd_HH-mm-ss', TimeZone.getTimeZone('Asia/Shanghai'))
                    def shareRoot = "/var/jenkins_home/share"
                    def targetDir = "${shareRoot}/${env.JOB_NAME}/${env.JOB_NAME}-${timestamp}"

                    def excludePattern = '**/target/*-sources.jar,**/target/*-javadoc.jar'
                    def trackerJar = findFiles(glob: 'main-project/devops-jobtracker/target/*.jar', excludes: excludePattern)
                    def coreJar = findFiles(glob: 'main-project/devops-core/target/*-exec.jar')
                    def taskJar = findFiles(glob: 'main-project/devops-tasktracker/target/*.jar', excludes: excludePattern)

                    if (trackerJar.length == 0 || coreJar.length == 0 || taskJar.length == 0) {
                        error "错误：一个或多个主构建产物 (*.jar) 未找到，无法归档！"
                    }

                    sh """
                        set -e
                        echo "INFO: 正在创建归档目录: ${targetDir}"
                        mkdir -p "${targetDir}"

                        echo "INFO: 正在归档 Git 日志 (从 main-project 目录)..."
                        (cd main-project && git log --since="7 days ago" --no-merges --pretty=format:"%h - %an, %ar : %s") > "${targetDir}/git_commit_log.txt"

                        echo "INFO: 正在归档主程序包..."
                        cp "${trackerJar[0].path}" "${targetDir}/"
                        cp "${coreJar[0].path}" "${targetDir}/"
                        cp "${taskJar[0].path}" "${targetDir}/"

                        cat <<EOF

========================================================================
✅ 构建产物已成功归档

   任务名称: ${env.JOB_NAME}
   构建时间: ${timestamp}
   归档路径: \\\\\\\\10.189.189.245\\\\share\\\\${env.JOB_NAME}\\\\${env.JOB_NAME}-${timestamp}
========================================================================

EOF
                    """
                }
            }
        }

        // ====================================================================
        // 阶段四：在 Jenkins 上归档构建产物
        // ====================================================================
        stage('Archive on Jenkins') {
            steps {
                script {
                    echo 'INFO: 正在 Jenkins 上归档构建产物...'

                    def artifactsToArchive = [
                        'main-project/devops-core/target/*-exec.jar',
                        'main-project/devops-jobtracker/target/*.jar',
                        'main-project/devops-tasktracker/target/*.jar'
                    ]

                    // 检查是否有新的 Git 提交，如果有，则生成并归档日志
                    def logOutput = sh(script: '(cd main-project && git log --since="7 days ago" --no-merges --pretty=format:"%h - %an, %ar : %s")', returnStdout: true).trim()
                    if (logOutput) {
                        echo 'INFO: 发现新的 Git 提交，将归档日志文件...'
                        sh 'rm -f git_commit_log.txt'
                        writeFile(file: 'git_commit_log.txt', text: logOutput)
                        artifactsToArchive.add('git_commit_log.txt')
                    } else {
                        echo 'INFO: 最近7天内无新的 Git 提交，跳过归档日志。'
                    }

                    // 归档所有产物
                    archiveArtifacts(
                        artifacts: artifactsToArchive.join(', '),
                        excludes: '**/target/*-sources.jar, **/target/*-javadoc.jar',
                        allowEmptyArchive: true
                    )
                }
            }
        }
    }
}
