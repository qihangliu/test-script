pipeline {
    // ====================================================================
    // 1. 定义构建环境
    // ====================================================================
    agent {
        docker {
            image 'node:14.15.0'
            // 关键：挂载两个命名卷，避免冲突
            // - npm-cache: 用于缓存 npm 下载的包
            // - node-modules-cache: 用于持久化 node_modules 目录（包含 .cache），实现极速增量安装 + 编译缓存
            args '-u root:root -v npm-cache:/root/.npm -v node-modules-cache:/workspace/node_modules --entrypoint='
        }
    }

    stages {
        // ====================================================================
        // 阶段：检出代码
        // ====================================================================
        stage('Checkout') {
            steps {
                echo 'INFO: 正在检出代码 (使用完整克隆)...'
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/shijiaxuan-pool']],
                    userRemoteConfigs: [[
                        url: 'https://gitee.com/changyunhuizhi/opwb-web.git',
                        credentialsId: 'd5208b73-a80f-403b-a5df-365614d1362e'
                    ]],
                    extensions: []
                ])
            }
        }

        // ====================================================================
        // 阶段：极速增量安装依赖
        // ====================================================================
        stage('Install Dependencies') {
            steps {
                sh '''
                    #!/bin/bash
                    set -e

                    echo "--> INFO: 正在开始极速增量安装..."
                    npm config set registry https://registry.npmmirror.com

                    CURRENT_CHECKSUM=$(md5sum package-lock.json | awk '{ print $1 }')
                    SAVED_CHECKSUM_FILE="node_modules/.lock-checksum"

                    if [ -f "$SAVED_CHECKSUM_FILE" ] && [ "$CURRENT_CHECKSUM" = "$(cat "$SAVED_CHECKSUM_FILE")" ]; then
                        echo "--> 成功: package-lock.json 未发生变化，跳过依赖安装。"
                    else
                        echo "--> INFO: package-lock.json 已发生变化，正在执行增量 'npm install'。"
                        npm install --no-audit --no-fund
                        echo "--> INFO: 正在为 package-lock.json 保存新的校验和。"
                        echo "$CURRENT_CHECKSUM" > "$SAVED_CHECKSUM_FILE"
                    fi
                '''
            }
        }

        // ====================================================================
        // 阶段：编译项目
        // ====================================================================
        stage('Build') {
            steps {
                echo 'INFO: 正在清理旧的构建产物...'
                sh 'rm -f dist.zip || true'

                // --- 注入多线程配置并禁用 Lint ---
                script {
                    def originalConfig = readFile('vue.config.js')
                    def injectedCode = """
// START: Injected multi-threading config and Lint disable
const isProd = process.env.NODE_ENV === 'production';
if (isProd) {
    console.log('✅ INFO: vue.config.js 注入成功，正在为 Babel-loader 注入多线程和缓存配置...');
    const jsRule = config.module.rule('js');
    if (jsRule) {
        console.log('✅ 确认: 已成功找到 js 规则，开始注入 loader...');
        jsRule.use('cache-loader')
            .loader('cache-loader')
            .end()
            .use('thread-loader')
            .loader('thread-loader')
            .options({
                workers: 8, // 硬编码核心数
                poolTimeout: 2000
            })
            .before('babel-loader');
        console.log('✅ 确认: cache-loader 和 thread-loader 已成功注入。');
    } else {
        console.log('❌ 警告: 未找到 js 规则，无法注入 loader。');
    }
}
// END: Injected multi-threading config and Lint disable
"""
                    def modifiedConfig = originalConfig.replaceFirst(
                        java.util.regex.Pattern.quote('chainWebpack: config => {'),
                        "chainWebpack: config => {\n${injectedCode}"
                    )
                    // 关键修改：将 lintOnSave: undefined, 替换为 lintOnSave: false,
                    modifiedConfig = modifiedConfig.replace('lintOnSave: undefined,', 'lintOnSave: false,')

                    writeFile(file: 'vue.config.js', text: modifiedConfig)
                    echo "INFO: 已在内存中修改并写回 vue.config.js，并已禁用 Lint。"
                }

                withEnv(['NODE_OPTIONS=--max-old-space-size=8192', 'BROWSERSLIST_IGNORE_OLD_DATA=true', 'BROWSERSLIST_UPDATE=false']) {
                    echo "INFO: 正在使用 NODE_OPTIONS=${env.NODE_OPTIONS} 进行编译..."
                    // 移除 --no-lint 参数，因为我们已通过修改配置文件来禁用它
                    sh 'NODE_ENV=production npm run build'
                }
            }
        }

        // ====================================================================
        // 阶段：打包产物
        // ====================================================================
        stage('Package Artifact') {
            steps {
                echo 'INFO: 正在将 dist 目录打包为 dist.zip...'
                // 修正：在项目根目录执行 zip 命令，确保 dist 目录被包含在压缩包中
                sh 'zip -qr dist.zip dist'
                archiveArtifacts artifacts: 'dist.zip', followSymlinks: false
            }
        }

        // ====================================================================
        // 阶段：归档到共享目录
        // ====================================================================
        stage('Archive to Share') {
            steps {
                script {
                    def timestamp = new Date().format('yy-MM-dd_HH-mm-ss', TimeZone.getTimeZone('Asia/Shanghai'))
                    def shareRoot = "${env.JENKINS_HOME}/share"
                    def targetDir = "${shareRoot}/${env.JOB_NAME}-${timestamp}"

                    sh """
                        set -e
                        echo "正在创建目标目录: ${targetDir}"
                        mkdir -p "${targetDir}"

                        echo "将当前工作区标记为 Git 安全目录..."
                        git config --global --add safe.directory ${env.WORKSPACE}

                        echo "正在生成 Git 日志..."
                        git log --since="7 days ago" --no-merges --pretty=format:"%h - %an, %ar : %s" > "${targetDir}/git_commit_log.txt"

                        echo "正在拷贝构建产物..."
                        cp "${env.WORKSPACE}/dist.zip" "${targetDir}/"

                        cat <<EOF
--------------------------------------------------------
文件已成功归档到目标目录
您现在可以通过以下网络路径从 Windows 访问：
\\\\\\\\10.189.189.245\\\\share\\\\${env.JOB_NAME}-${timestamp}
或者先访问 \\\\\\\\10.189.189.245\\\\share 再进入对应目录
--------------------------------------------------------
EOF
                    """
                }
            }
        }
    }

    post {
        always {
            echo '构建流程已结束。'
        }
    }
}